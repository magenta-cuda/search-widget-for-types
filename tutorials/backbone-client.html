<!DOCTYPE html>
<html>
<head>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/jquery/jquery-migrate.min.js'></script>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/underscore.min.js'></script>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/backbone.min.js'></script>
<script type='text/javascript'>
    // This can be used to set the WordPress AJAX URL; only neccessary if different from window.location.origin + '/wp-admin/admin-ajax.php'
    //window.mcst = window.mcst || {};
    //window.mcst.ajaxUrl = "http://me.local.com/wp-admin/admin-ajax.php"
</script>
<script type='text/javascript' src='http://me.local.com/wp-content/plugins/search-types-custom-fields-widget/js/wp-mcst-api.js'></script>
</head>
<body>
<h1>A Minimal REST Backbone Client Application</h1>
<div style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;">
<p>This is a simple application that shows how to use the JavaScript/Backbone client library.
Except for the JavaScript libraries the source for this application is contained entirely within this HTML document.
Most of the code is for creating the GUI.
The code for actually doing the REST request/response are in the form's submit callback and the function doRestRequest() and consists of only about 40 verbose lines of code.</p>
<p>This is an &quot;extreme&quot; example as this HTML document is not generated by WordPress.
WordPress's role in this application is entirely just as a REST server.
The page layout in Backbone applications can be handled by JavaScript code.
A more typical application would use WordPress to generate the header, sidebar and footer and use a REST Backbone client to dynamically generate the post content.</p>
</div>
<h1>Toolset Types Custom Post Types:</h1>
<pre class="parameters" style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;"></pre>
<h1>Please Specify the REST Request:</h1>
<form id="set-request-parameters"style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;">
<button id="add-parameter" type="button">Add Another Parameter</button>
<button id="remove-parameter" type="button">Remove Last Parameter</button>
<button id="do-request" type="submit">Send the Request</button>
</form>
<h1>The REST Request:</h1>
<pre class="request" style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;"></pre>
<h1>The REST Results:</h1>
<pre class="result" style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;"></pre>
<script type="text/javascript">
( function() {
    var parametersForCollection = { };
    function createParameterInput( collection ) {
        var parameters = parametersForCollection[collection];
        var div = document.createElement( "div" );
        div.className = "parameter";
        var select = document.createElement( "select" );
        for ( var parameter in parameters ) {
            var option = document.createElement( "option" );
            option.textContent = parameter;
            if ( parameter === "search" ) {
                option.selected = true;
            }
            select.appendChild( option );
        }
        div.appendChild( select );
        var input = document.createElement( "input" );
        input.type = "text";
        input.size = "80";
        input.placeholder = parameters["search"];
        div.appendChild( input );
        select.addEventListener( "change", function( ) {
            input.placeholder = parameters[this.value];
        } );
        return div;
    }
    function createCollectionSelect( ) {
        var select = document.createElement( "select" );
        select.style.display = "block";
        var selected;
        for ( var collection in parametersForCollection ) {
            var option = document.createElement( "option" );
            option.textContent = collection;
            if ( !selected ) {
                option.selected = true;
                selected = collection;
            }
            select.appendChild( option );
        }
        var form = document.querySelector( "form#set-request-parameters" );
        var addParmButton = form.querySelector( "button#add-parameter" );
        var removeParmButton = form.querySelector( "button#remove-parameter" );
        var requestButton = form.querySelector( "button#do-request" );
        form.insertBefore( select, addParmButton );
        function createFirstParameterSelect( collection ) {
            for ( var div = form.querySelector( "div.parameter" ); div; div = form.querySelector( "div.parameter" ) ) {
                form.removeChild( div );
            }
            form.insertBefore( createParameterInput( collection ), addParmButton );
        }
        createFirstParameterSelect( selected );
        select.addEventListener( "change", function( ) {
            createFirstParameterSelect( this.value );
        } );
        addParmButton.addEventListener( "click", function( ) {
            form.insertBefore( createParameterInput( select.value ), addParmButton );
        } );
        removeParmButton.addEventListener( "click", function( ) {
            form.removeChild( form.querySelector( "div:last-of-type" ) );
        } );
        // The form's submit callback creates the REST request and calls doRestRequest()
        form.addEventListener( 'submit', function( event ) {
            event.preventDefault();
            // create empty collection for selected post type
            var collection = new mcst.api.collections[select.value]();
            request = { };
            form.querySelectorAll( "div.parameter" ).forEach( function( div ) {
                var field = div.querySelector( "select" ).value;
                var value = div.querySelector( "input" ).value;
                switch ( typeof request[field] ) {
                case "undefined":
                    request[field] = value;
                    break;
                case "string":
                    request[field] = [ request[field], value ];
                    break;
                case "object":
                    request[field].push( value );
                    break;
                }
            } );
            // fill collection by sending a REST request
            doRestRequest( collection, request );
        } );
    }
    // doRestRequest() sends the REST request and handles the REST response
    function doRestRequest( collection, request ) {
        document.querySelector("pre.request").textContent = JSON.stringify( { "Collection": collection.name, "Parameters": request }, null, 4 );
        // use the Backbone.js collection.fetch() method to send the REST request
        collection.fetch( {
            data: request,
            success: function( collection, response, options ) {
                // use JSON.stringify() to dump the collection to the browser
                document.querySelector("pre.result").textContent = JSON.stringify( collection, null, 4 );
            },
            error: function( collection, response, options ) {
                alert( "fetch() failed." );
            }
        } );
    }
    // restLoadPromise is used register callbacks to be called when the REST API becomes available
    window.mcst.restLoadPromise.done( function() {
        var collections = mcst.api.collections;
        content = "";
        for ( var collection in collections ) {
            content += "name: " + collection + "\n";
            var options = collections[collection].prototype.options;
            parametersForCollection[collection] = { };
            for ( var option in options ) {
                content += "    " + option + ": " + options[ option ].description + "\n";
                parametersForCollection[collection][option] = options[option].description;
            }
        }
        document.querySelector("pre.parameters").textContent = content;
        createCollectionSelect( );
        // this is used for testing the wp.api
        //var collection = new wp.api.collections.Posts();
        //var request = { include: [ 1 ] };
        //doRestRequest( collection, request );
    } );
} )();
</script>
</body>
</html>
