<!DOCTYPE html>
<html>
<head>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/jquery/jquery-migrate.min.js'></script>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/underscore.min.js'></script>
<script type='text/javascript' src='http://me.local.com/wp-includes/js/backbone.min.js'></script>
<script type='text/javascript'>
    // This can be used to set the WordPress AJAX URL; only neccessary if different from window.location.origin + '/wp-admin/admin-ajax.php'
    //window.mcst = window.mcst || {};
    //window.mcst.ajaxUrl = "http://me.local.com/wp-admin/admin-ajax.php"
</script>
<script type='text/javascript' src='http://me.local.com/wp-content/plugins/search-types-custom-fields-widget/js/wp-mcst-api.js'></script>
</head>
<body>
<h1>Toolset Types Custom Post Types:</h1>
<pre class="parameters" style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;"></pre>
<form id="set-request-parameters">
<button type="submit">Get It</button>
</form>
<h1>Request:</h1>
<pre class="request" style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;"></pre>
<h1>Results:</h1>
<pre class="result" style="border:2px solid black;padding:10px;margin:20px;overflow-x:auto;"></pre>
<script type="text/javascript">
( function() {
    var parametersForCollection = { };
    function createCollectionSelect( ) {
        var select = document.createElement( "select" );
        select.style.display = "block";
        var selected;
        for ( var collection in parametersForCollection ) {
            var option = document.createElement( "option" );
            option.textContent = collection;
            if ( !selected ) {
                option.selected = true;
                selected = collection;
            }
            select.appendChild( option );
        }
        var form = document.querySelector( "form#set-request-parameters" );
        var button = form.querySelector( "button" );
        form.insertBefore( select, button );
        function createFirstParameterSelect( collection ) {
            for ( var div = form.querySelector( "div.parameter" ); div; div = form.querySelector( "div.parameter" ) ) {
                form.removeChild( div );
            }
            form.insertBefore( createParameterInput( collection ), button );
        }
        createFirstParameterSelect( selected );
        select.addEventListener( "change", function( ) {
            createFirstParameterSelect( this.value );
        } );
        form.addEventListener( 'submit', function( event ) {
            event.preventDefault();
            var collection = new mcst.api.collections[select.value]();
            request = { };
            form.querySelectorAll( "div.parameter" ).forEach( function( div ) {
                request[div.querySelector( "select" ).value] = div.querySelector( "input" ).value;
            } );
            doRestRequest( collection, request );
        } );
    }
    function createParameterInput( collection ) {
        var parameters = parametersForCollection[collection];
        var div = document.createElement( "div" );
        div.className = "parameter";
        var select = document.createElement( "select" );
        for ( var parameter in parameters ) {
            var option = document.createElement( "option" );
            option.textContent = parameter;
            if ( parameter === "search" ) {
                option.selected = true;
            }
            select.appendChild( option );
        }
        div.appendChild( select );
        var input = document.createElement( "input" );
        input.type = "text";
        input.size = "80";
        input.placeholder = parameters["search"];
        div.appendChild( input );
        select.addEventListener( "change", function( ) {
            input.placeholder = parameters[this.value];
        } );
        return div;
    }
    function doRestRequest( collection, request ) {
        document.querySelector("pre.request").textContent = JSON.stringify( { "Collection": collection.name, "Parameters": request }, null, 4 );
        collection.fetch( {
            data: request,
            success: function( collection, response, options ) {
                document.querySelector("pre.result").textContent = JSON.stringify( collection, null, 4 );
            },
            error: function( collection, response, options ) {
                alert( "fetch() failed." );
            }
        } );
    }
    // restLoadPromise is used register callbacks to be called when the REST API becomes available
    window.mcst.restLoadPromise.done( function() {
        var collections = mcst.api.collections;
        content = "";
        for ( var collection in collections ) {
            content += "name: " + collection + "\n";
            var options = collections[collection].prototype.options;
            parametersForCollection[collection] = { };
            for ( var option in options ) {
                content += "    " + option + ": " + options[ option ].description + "\n";
                parametersForCollection[collection][option] = options[option].description;
            }
        }
        document.querySelector("pre.parameters").textContent = content;
        createCollectionSelect( );
        // this is used for testing the wp.api
        //var collection = new wp.api.collections.Posts();
        //var request = { include: [ 1 ] };
        //doRestRequest( collection, request );
    } );
} )();
</script>
</body>
</html>
